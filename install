#!/usr/bin/env bash
set -euo pipefail

# ---------------- UI ----------------

print_attention() {
  local msg="$1"
  local width=78
  local border
  border=$(printf '═%.0s' $(seq 1 "$width"))

  # Interpret \n, \t, etc.
  msg="$(printf '%b' "$msg")"

  echo
  echo -e "\033[1;33m╔$border╗\033[0m"

  while IFS= read -r line; do
    printf "\033[1;33m║\033[0m \033[1;97m%-*s\033[0m \033[1;33m║\033[0m\n" \
      "$width" "$line"
  done <<< "$msg"

  echo -e "\033[1;33m╚$border╝\033[0m"
  echo
}

# ---------------- Package manager detect ----------------

if command -v yay >/dev/null 2>&1; then
  PKG_MANAGER="arch"
elif command -v dnf >/dev/null 2>&1; then
  PKG_MANAGER="fedora"
else
  echo "No supported package manager found (yay or dnf required)"
  exit 1
fi

# ---------------- Fedora proton-shim build ----------------

fedora() {
  sudo dnf install -y zip fuse git make python3

  command -v proton-shim >/dev/null 2>&1 && return 0
  git clone https://gitlab.com/Wisher/ProtonShim.git
  cd proton-shim
  sudo make install
  cd ..
  rm ProtonShim
}

case "$PKG_MANAGER" in
  arch)
    yay -S --needed --noconfirm proton-shim fuse2 zip
    ;;
  fedora)
    fedora
    ;;
esac

# ---------------- Paths ----------------

INSTALL_DIR="$HOME/Games/Starfield"
mkdir -p "$HOME/Games"

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"

# ---------------- Download Jackify ----------------

JACKIFY="$SCRIPT_DIR/Jackify.AppImage"
if [[ -f "$JACKIFY" ]]; then
    print_attention "Found Jackify"
else
    print_attention "Downloading Jackify…"
    curl -fsSL https://api.github.com/repos/Omni-guides/Jackify/releases/latest \
        | grep -m1 browser_download_url \
        | grep -i '\.AppImage"' \
        | cut -d '"' -f 4 \
        | xargs -I{} curl -fL {} -o "$JACKIFY"

    chmod +x "$JACKIFY"
fi

# ---------------- Download Installer ---------------


# ---------------- Find Starfield ----------------

STARFIELD_APPID="$(
  proton-shim -l games | awk '/\[Starfield\]/ { gsub(/[\[\]]/, "", $1); print $1; exit }'
)"

if [[ -z "$STARFIELD_APPID" ]]; then
  print_attention "Could not find Starfield installation.\n\nRun Starfield once in Steam, then re-run this script."
  exit 1
fi

print_attention "Found Starfield (AppID: $STARFIELD_APPID)"

PFX_DRIVE_C="$HOME/.local/share/Steam/steamapps/compatdata/$STARFIELD_APPID/pfx/drive_c"

if [[ ! -d "$PFX_DRIVE_C" ]]; then
  echo "Wine prefix not found: $PFX_DRIVE_C"
  exit 1
fi

if [[ -L "$INSTALL_DIR" ]]; then
  print_attention "Starfield symlink already exists"
elif [[ -e "$INSTALL_DIR" ]]; then
  print_attention "ERROR: $INSTALL_DIR exists but is not a symlink"
  exit 1
else
  ln -s "$PFX_DRIVE_C" "$INSTALL_DIR"
  print_attention "Created Starfield symlink"
fi

# ---------------- Run installer ----------------

SETUP_EXE="$SCRIPT_DIR/StarWarsGenesisSetup.exe"

if [[ -f "$SETUP_EXE" ]]; then
  print_attention "Found StarWarsGenesisSetup.exe"
else
  print_attention "Downloading StarWarsGenesisSetup.exe…"

  curl -fL \
    "https://github.com/Vxjoe96/GenisisInstaller/releases/download/Release/StarWarsGenesisSetup.exe" \
    -o "$SETUP_EXE" \
    || { echo "ERROR: Failed to download installer"; exit 1; }
fi

chmod +x "$SETUP_EXE"

print_attention "Running installer…\n\nUNCHECK: Run Wabbajack"

proton-shim -e "$SETUP_EXE" -p "Proton - Experimental" "$STARFIELD_APPID" >/dev/null 2>&1

clear
print_attention "Installer Completed"

# ---------------- Instructions ----------------

print_attention "$(cat <<'EOF'
AUTHORIZE NEXUS AUTHENTICATION
--------------------------------
Authorize Nexus authentication in Settings (bottom-left) and SAVE.
If this fails, re-run the script and input the API key manually.

INSTALL MODLIST
----------------
• Choose 'Modlist Tasks'
• Choose 'Install a Modlist (Automated)'
• Select 'Use .wabbajack File'
• Browse to:
  ~/Games/STARFIELD/Star Wars Genesis/Compiler
• Select the Star Wars Genesis .wabbajack file

INSTALL DETAILS
----------------
• Modlist name:
  Star Wars Genesis
• Install location:
  ~/Games/STARFIELD/Star Wars Genesis/Game/
• Download location:
  Anywhere
• Choose resolution
• Select 'Start Installation'
EOF
)"

"$SCRIPT_DIR/Jackify.AppImage"

