#!/usr/bin/env bash
set -euo pipefail

# ---------------- UI ----------------

print_attention() {
  local msg="$1"
  local width=78
  local border
  border=$(printf '═%.0s' $(seq 1 "$width"))

  # Interpret \n, \t, etc.
  msg="$(printf '%b' "$msg")"

  echo
  echo -e "\033[1;33m╔$border╗\033[0m"

  while IFS= read -r line; do
    printf "\033[1;33m║\033[0m \033[1;97m%-*s\033[0m \033[1;33m║\033[0m\n" \
      "$width" "$line"
  done <<< "$msg"

  echo -e "\033[1;33m╚$border╝\033[0m"
  echo
}

# ---------------- Package manager detect ----------------

if command -v yay >/dev/null 2>&1; then
  PKG_MANAGER="arch"
elif command -v dnf >/dev/null 2>&1; then
  PKG_MANAGER="fedora"
else
  echo "No supported package manager found (yay or dnf required)"
  exit 1
fi

# ---------------- Fedora proton-shim build ----------------

fedora() {

}

case "$PKG_MANAGER" in
  arch)
    yay -S --needed --noconfirm fuse2
    ;;
  fedora)
    fedora
    ;;
esac

# ---------------- Paths ----------------

INSTALL_DIR="$HOME/Games/Starfield"
mkdir -p "$HOME/Games"

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"

PROTON_SHIM="$SCRIPT_DIR/proton-shim.sh"

chmod +x "$PROTON_SHIM"

proton-shim() {
  "$PROTON_SHIM" "$@"
}

# ---------------- Download Jackify ----------------

JACKIFY="$SCRIPT_DIR/Jackify.AppImage"
if [[ -f "$JACKIFY" ]]; then
    print_attention "Found Jackify"
else
    print_attention "Downloading Jackify…"
    curl -fsSL https://api.github.com/repos/Omni-guides/Jackify/releases/latest \
        | grep -m1 browser_download_url \
        | grep -i '\.AppImage"' \
        | cut -d '"' -f 4 \
        | xargs -I{} curl -fL {} -o "$JACKIFY"

    chmod +x "$JACKIFY"
fi

# ---------------- Download Installer ---------------


# ---------------- Find Starfield ----------------

STARFIELD_APPID="$(
  proton-shim -l games | awk '/\[Starfield\]/ { gsub(/[\[\]]/, "", $1); print $1; exit }'
)"

if [[ -z "$STARFIELD_APPID" ]]; then
  print_attention "Could not find Starfield installation.\n\nRun Starfield once in Steam, then re-run this script."
  exit 1
fi

print_attention "Found Starfield (AppID: $STARFIELD_APPID)"

PFX_DRIVE_C="$HOME/.local/share/Steam/steamapps/compatdata/$STARFIELD_APPID/pfx/drive_c"

if [[ ! -d "$PFX_DRIVE_C" ]]; then
  echo "Wine prefix not found: $PFX_DRIVE_C"
  exit 1
fi

if [[ -L "$INSTALL_DIR" ]]; then
  print_attention "Starfield symlink already exists"
elif [[ -e "$INSTALL_DIR" ]]; then
  print_attention "ERROR: $INSTALL_DIR exists but is not a symlink"
  exit 1
else
  ln -s "$PFX_DRIVE_C" "$INSTALL_DIR"
  print_attention "Created Starfield symlink"
fi

# ---------------- Run installer ----------------

SETUP_EXE="$SCRIPT_DIR/StarWarsGenesisSetup.exe"

if [[ -f "$SETUP_EXE" ]]; then
  print_attention "Found StarWarsGenesisSetup.exe"
else
  print_attention "Downloading StarWarsGenesisSetup.exe…"

  curl -fL \
    "https://github.com/Vxjoe96/GenisisInstaller/releases/download/Release/StarWarsGenesisSetup.exe" \
    -o "$SETUP_EXE" \
    || { echo "ERROR: Failed to download installer"; exit 1; }
fi

chmod +x "$SETUP_EXE"

print_attention "Running installer…\n\nUNCHECK: Run Wabbajack"

proton-shim -e "$SETUP_EXE" -p "Proton - Experimental" "$STARFIELD_APPID" >/dev/null 2>&1

clear
print_attention "Installer Completed"

# ---------------- Instructions ----------------

print_attention "$(cat <<'EOF'
AUTHORIZE NEXUS AUTHENTICATION
--------------------------------
Authorize Nexus authentication in Settings (bottom-left) and SAVE.
If this fails, re-run the script and input the API key manually.

INSTALL MODLIST
----------------
• Choose 'Modlist Tasks'
• Choose 'Install a Modlist (Automated)'
• Select 'Use .wabbajack File'
• Browse to:
  ~/Games/STARFIELD/Star Wars Genesis/Compiler
• Select the Star Wars Genesis .wabbajack file

INSTALL DETAILS
----------------
• Modlist name:
  Star Wars Genesis
• Install location:
  ~/Games/STARFIELD/Star Wars Genesis/Game/
• Download location:
  Anywhere
• Choose resolution
• Select 'Start Installation'
EOF
)"

"$SCRIPT_DIR/Jackify.AppImage" & disown

mv ./DeityVengy was here.ico "$HOME/Games/Starfield/users/steamuser/Documents/My Games/Starfield/"
mv ./StarfieldCustom.ini "$HOME/Games/Starfield/users/steamuser/Documents/My Games/Starfield/"
# ---------- Set Perf Settings ----------

INI_PATH="$HOME/Games/Starfield/users/steamuser/Documents/My Games/Starfield/StarfieldPrefs.ini"

[[ -f "$INI_PATH" ]] || {
  echo "ERROR: $INI_PATH not found"
  exit 1
}

tmp="$(mktemp)"
trap 'rm -f "$tmp"' EXIT

# ---------- TARGET VALUES ----------

declare -A TARGETS=(
  # Display
  ["Display.fRenderResolutionScaleFactor"]="1.0000"
  ["Display.bDynamicResolutionEnabled"]="0"
  ["Display.uiUpscalingTechnique"]="1"
  ["Display.uiFrameGenerationTech"]="0"
  ["Display.fFilmGrainIntensity"]="0.0000"
  ["Display.bEnableVsync"]="0"
  ["Display.fGamma"]="2.6200"
  ["Display.fContrast"]="0.9000"
  ["Display.fContrastUI"]="0.9000"
  ["Display.fGammaUI"]="2.6200"

  # Quality
  ["Quality.uMotionBlur"]="0"
  ["Quality.uSAO"]="3"
  ["Quality.bMotionBlurEnabled"]="0"
  ["Quality.uContactShadows"]="2"
  ["Quality.uGrass"]="2"
  ["Quality.uCrowd"]="3"
  ["Quality.uVolumetricLighting"]="2"
  ["Quality.uParticle"]="2"
  ["Quality.uReflections"]="2"
  ["Quality.uGlobalIllumination"]="2"
  ["Quality.uShadows"]="2"

  # Interface
  ["Interface.bDialogueEnable"]="0"
  ["Interface.bDialogueSubtitles"]="1"
  ["Interface.bGeneralSubtitles"]="1"
  ["Interface.bDamageNumbersEnabled"]="0"

  # Audio
  ["Audio.fAudioVolumeMusic"]="1.0000"
  ["Audio.fAudioVolumeMaster"]="1.0000"
  ["Audio.fAudioVolumeEffects"]="1.0000"

  # Camera
  ["Camera.bDisableAutoVanityMode"]="1"

  # General
  ["General.bDisplayCreditCTA"]="0"

  # Legal
  ["Legal.iHasUserAcceptedVersion"]="1"
  ["Legal.bHasUserAccepted"]="1"

  # GamePlay
  ["GamePlay.bSaveOnPause"]="0"
)

# ---------- PROCESS FILE ----------

awk -v OFS="" -v targets="$(declare -p TARGETS)" '
BEGIN {
  eval targets
}

function emit_missing(section) {
  for (k in TARGETS) {
    split(k, a, ".")
    if (a[1] == section && !seen[k]) {
      print a[2], "=", TARGETS[k]
    }
  }
}

{
  if ($0 ~ /^\[.+\]$/) {
    if (section != "") {
      emit_missing(section)
    }
    section = substr($0, 2, length($0)-2)
    print
    next
  }

  if (match($0, /^([^;#=\s]+)[[:space:]]*=[[:space:]]*(.*)$/, m)) {
    key = section "." m[1]
    if (key in TARGETS) {
      print m[1], "=", TARGETS[key]
      seen[key] = 1
      next
    }
  }

  print
}

END {
  if (section != "") {
    emit_missing(section)
  }

  # Add missing sections
  for (k in TARGETS) {
    split(k, a, ".")
    if (!(a[1] in section_seen)) {
      print "", "[" a[1] "]"
      for (x in TARGETS) {
        split(x, b, ".")
        if (b[1] == a[1]) {
          print b[2], "=", TARGETS[x]
        }
      }
      section_seen[a[1]] = 1
    }
  }
}
' "$INI_PATH" > "$tmp"

mv "$tmp" "$INI_PATH"

echo "StarfieldPrefs.ini has been updated. No spacing errors."


